---
title: "Recruiting Chapter"
author: 
  - Ozan Jaquette
  - Crystal Han
  - Irma Castaneda
bibliography: ./../other/burd_recruiting_chapter.bib
output: 
  bookdown::pdf_document2:
    toc: FALSE
csl: ./../other/apa.csl
urlcolor: blue
header-includes:
      - \usepackage{pdflscape}
      - \usepackage{geometry}
      - \usepackage{floatrow}
      - \floatsetup{capposition=top}
---

```{r setup, include=FALSE}
library(knitr)
library(bookdown)

library(kableExtra)
library(tidyverse)
library(gridExtra)
```


# Results

ADD TABLE OF UNIVERSITY CHARACTERISTICS HERE

## RQ1: Scale

Table \@ref(fig:event-count-figure-pubu): event count public universities


Table \@ref(fig:event-count-figure-privu): event count, private univerisites



## RQ2: Characteristics of high schools


```{r, include = FALSE}
# ggplot's default color palette
 library(scales)
# show_col(hue_pal()(4))


plot_characteristic <- function(df, type, characteristic, label_text, visit_count = FALSE) {
  
  if (visit_count) {
    df <- df %>% mutate(univ_name = str_c(univ_name, ' (N=', total, ')'))
  }
  
  # create variable for university region; and turn rank into a numeric variable
  df <- df %>% mutate(
    univ_region=factor(
      str_split(characteristics, pattern = '\\|', simplify=TRUE)[,1],levels = c('northeast','midwest','south','west')),
    rank = as.numeric(rank)
  )

  if (type == 'region') {
    ordered_df <- df %>% arrange(univ_region, univ_name)
  } else {
    ordered_df <- df %>% arrange(rank, univ_name)
  }
  
  univ_order <- ordered_df$univ_name

  sub_df <- df %>% select(univ_name, all_of(characteristic)) %>%
    gather(key, value, characteristic) %>%
    mutate(value = parse_number(value))

  sub_df$univ_name <- factor(sub_df$univ_name, levels = rev(univ_order))
  sub_df$key <- factor(sub_df$key, levels = characteristic)

  ggplot(sub_df, aes(fill = key, y = value, x = univ_name)) + 
    geom_bar(stat='identity', position = position_fill(reverse = TRUE)) +
    ggtitle('Title') +
    xlab('') + ylab('') +
    labs(fill = type) +
    scale_fill_manual(labels = label_text, values = c('#F8766D', '#7CAE00', '#00BFC4', '#C77CFF')) +
    scale_y_continuous(labels = scales::percent, expand = c(0, 0, 0.05, 0)) +
    theme(legend.position = 'top',
          legend.title = element_text(size = 6, face = 'bold'),
          legend.text = element_text(size = 6),
          legend.margin = margin(0, 0, 0, 0),
          legend.box.margin = margin(0, 0, -5, -30),
          legend.key.size = unit(0.3, 'cm'),
          panel.background = element_blank(),
          axis.ticks.y = element_blank(),
          text = element_text(size = 8),
          plot.title = element_text(color = 'white')) +
    coord_flip()
}

# create function to run the plot_characteristic() function
#plot_characteristic <- function(df, type, characteristic, label_text, visit_count = FALSE) {


run_plot_characteristics <- function(which_psi,which_char,char_label,which_vars,which_labels) {
  
  # stuff to use later
    num_plot <- length(which_psi)
    name_suf <- str_c(which_psi,collapse = '_')
    
  #print function values as a check
    print(which_psi)
    #print(name_suf)
    #print(num_plot)
    print(str_c('which_char=',which_char))
    print(str_c('char_label=',char_label))
    #print(which_vars)
    #print(which_labels)

  # initiate pdf
  pdf(file.path('.','..', 'assets', 'figures', str_c('ego_network_figure_', which_char,'_',name_suf, '.pdf')))
    par(mar=c(0, 0, 0, 0) + 0.1, mai=c(0, 0, 0, 0))
    par(mfrow=c(2, 1))
  
  #loop to create figure separately for each psi type
  plot_list <- vector("list", length(which_psi))
  for (i in 1:length(which_psi)) {
    
    plot_list[[i]] <- plot_characteristic(
      df = readRDS(file.path('.','..', 'assets', 'tables', str_c('table_ego_', which_psi[i], '.RDS'))),
      #df = readRDS(file.path('.','..', 'assets', 'tables', str_c('table_ego_', 'pubu', '.RDS'))),
      type = char_label,
      characteristic = which_vars,
      label_text = which_labels,
      visit_count = TRUE
    )

  }

  # plot sub-plots in grid
  do.call("grid.arrange", c(plot_list, nrow=num_plot, ncol=1))

  dev.off()

}

# region
  # pubu, privu, privc
  run_plot_characteristics(which_psi = c('pubu','privu','privc'), which_char = 'region', char_label = 'Region', which_vars = c('northeast', 'midwest', 'south', 'west'),which_labels =c('Northeast', 'Midwest', 'South', 'West'))
  # pubu and privu
  run_plot_characteristics(which_psi = c('pubu','privu'), which_char = 'region', char_label = 'Region', which_vars = c('northeast', 'midwest', 'south', 'west'),which_labels =c('Northeast', 'Midwest', 'South', 'West'))
  
# religion
  # pubu, privu, privc
  run_plot_characteristics(which_psi = c('pubu','privu','privc'), which_char = 'religion', char_label = 'Religion', which_vars = c('catholic', 'christian', 'other', 'nonsectarian'), c('Catholic', 'Christian', 'Other religion', 'Nonsectarian'))
  
  # pubu, privu
  run_plot_characteristics(which_psi = c('pubu','privu'), which_char = 'religion', char_label = 'Religion', c('catholic', 'christian', 'other', 'nonsectarian'), c('Catholic', 'Christian', 'Other religion', 'Nonsectarian'))

# high school rank
  # pubu, privu, privc
  run_plot_characteristics(which_psi = c('pubu','privu','privc'), which_char = 'hs_rank', char_label = 'HS rank', c('c1_top200', 'c2_A+', 'c3_A', 'c4_ltA'), c('Top 200 A+', 'Other A+', 'A', 'Less than A'))
  # pubu, privu  
  run_plot_characteristics(which_psi = c('pubu','privu'), which_char = 'hs_rank', char_label = 'HS rank', c('c1_top200', 'c2_A+', 'c3_A', 'c4_ltA'), c('Top 200 A+', 'Other A+', 'A', 'Less than A'))
  
# racial composition
  # pubu, privu, privc  
  run_plot_characteristics(which_psi = c('pubu','privu','privc'), which_char = 'pct_black_latinx_native', char_label = '% Black/Latinx/Native', c('c1_lt10', 'c2_10to20', 'c3_20to50', 'c4_50+'), c('<10%', '10-20%', '20-50%', '50%+'))  
  # pubu, privu  
  run_plot_characteristics(which_psi = c('pubu','privu'), which_char = 'pct_black_latinx_native', char_label = '% Black/Latinx/Native', c('c1_lt10', 'c2_10to20', 'c3_20to50', 'c4_50+'), c('<10%', '10-20%', '20-50%', '50%+'))  
  
  plot_characteristic(
    df = readRDS(file.path('.','..', 'assets', 'tables', str_c('table_ego_', 'pubu', '.RDS'))),
    '% Black/Latinx/Native', c('c1_lt10', 'c2_10to20', 'c3_20to50', 'c4_50+'), c('<10%', '10-20%', '20-50%', '50%+'), visit_count = TRUE
  )
  
# enrollment
  # pubu, privu, privc  
  run_plot_characteristics(which_psi = c('pubu','privu','privc'), which_char = 'g12_enroll', char_label = '12th grade enrollment', c('c1_lt50','c2_50to100','c3_100to150','c4_gt150'), c('LT 50','50-100','100-150','GT 150'))
  
  #run_plot_characteristics(which_psi = c('pubu','privu','privc'), which_char = 'g12_enroll', char_label = '12th grade enrollment', c('c1_lt100','c2_100to150','c3_150to200','c4_gt200'), c('LT 100','100-150','150-200','GT 200'))
  
  # pubu, privu
  run_plot_characteristics(which_psi = c('pubu','privu'), which_char = 'g12_enroll', char_label = '12th grade enrollment', c('c1_lt50','c2_50to100','c3_100to150','c4_gt150'), c('LT 50','50-100','100-150','GT 150'))
  
```



## RQ3: Overlapping sets of high schools



# References

<div id="refs"></div>

<!-- TABLES -->

\newpage
<!-- private col/univ -->

```{r hs-print-privu, echo = FALSE, eval = FALSE}
df <- readRDS('./../assets/tables/table_2mode_privu.RDS') %>% head(n=20)

knitr::kable(
  df %>% select(-name,-closeness), caption = 'Top 20 most central private HS visited by private institutions') %>% 
  landscape(margin = NULL) %>%
  kable_styling(latex_options = 'scale_down')
```


```{r hs-table-privu-agg, echo = FALSE, eval = FALSE}
df <- readRDS('./../assets/tables/table_2mode_agg_privu.RDS')

knitr::kable(df, caption = 'Characteristics of private HS visited by private institutions, by degree band') %>% 
  landscape(margin = NULL) %>%
  kable_styling(latex_options = 'scale_down')
```

<!-- public research universities -->

```{r hs-print-pubu, echo = FALSE, eval = FALSE}
df <- readRDS('./../assets/tables/table_2mode_pubu.RDS') %>% head(n=20)

knitr::kable(
  df %>% select(-name,-closeness), caption = 'Top 20 most central private HS visited by public institutions') %>% 
  landscape(margin = NULL) %>%
  kable_styling(latex_options = 'scale_down')
```


```{r hs-table-pubu-agg, echo = FALSE, eval = FALSE}
df <- readRDS('./../assets/tables/table_2mode_agg_pubu.RDS')

knitr::kable(df, caption = 'Characteristics of private HS visited by public institutions, by degree band') %>% 
  landscape(margin = NULL) %>%
  kable_styling(latex_options = 'scale_down')
```

<!-- public and private col/univ -->

```{r hs-print-both, echo = FALSE, eval = FALSE}
df <- readRDS('./../assets/tables/table_2mode_both.RDS') %>% head(n=20)

knitr::kable(
  df %>% select(-name,-closeness), caption = 'Top 20 most central private HS visited by all institutions') %>% 
  landscape(margin = NULL) %>%
  kable_styling(latex_options = 'scale_down')
```


```{r hs-table-both-agg, echo = FALSE, eval = FALSE}
df <- readRDS('./../assets/tables/table_2mode_agg_both.RDS')

knitr::kable(df, caption = 'Characteristics of private HS visited by all institutions, by degree band') %>% 
  landscape(margin = NULL) %>%
  kable_styling(latex_options = 'scale_down')
```


<!-- ###################################################################################### FIGURES -->


```{r em-funnel, echo = FALSE, fig.align = 'center', fig.cap = "The enrollment funnel", out.width = "70%"}
knitr::include_graphics('./../assets/images/enrollment_funnel.png')
#![The enrollment funnel](assets/images/enrollment_funnel.png)
```


<!-- ########################################################## RQ 1: SCALE -->


```{r event-count-figure-pubu, fig.align = 'center', echo = FALSE, fig.cap = "Number of events by type and in-state, out-of-state for public institutions"}
knitr::include_graphics('./../assets/figures/plot_event_count_pubu.pdf')
```

```{r event-count-figure-privu, fig.align = 'center', echo = FALSE, fig.cap = "Number of events by type and in-state, out-of-state for private institutions"}
knitr::include_graphics('./../assets/figures/plot_event_count_privu.pdf')
```

<!-- ADD FIGURES: FIGURE X. Number of events at public high schools and private high schools 
      within each university, separate line for in-state and out-of-state
      separate figures for public and private universities
-->

<!-- ADD FIGURES: FIGURE X. Actual vs. proportional number of visits to private high schools
      within each university, separate line for in-state and out-of-state
      separate figures for public and private universities
-->



<!-- ########################################################## RQ 2: Characteristics of high schools -->


\restoregeometry

\newgeometry{top=1in, left=0cm, right=0cm, bottom=0cm}

\newpage

```{r privhs-universe, fig.align = 'center', echo = FALSE, fig.cap = "Characteristics of private high schools"}
knitr::include_graphics('./../assets/figures/plot_pss_universe.pdf')
```


\begin{center}
* \textit{Universe of private HS (N=3673), private HS visited by sample institutions (N=1738); Universe of private HS is defined as any private schools that enrolls at least ten grade 12.}
\end{center}


\newpage


```{r ego-network-figure-region, fig.align = 'center', echo = FALSE, fig.cap = "Geographic region of visited private high schools"}
knitr::include_graphics('./../assets/figures/ego_network_figure_region_pubu_privu_privc.pdf')
#knitr::include_graphics('./../assets/figures/ego_network_figure_region_pubu_privu.pdf')
```

\newpage

```{r ego-network-figure-religion, fig.align = 'center', echo = FALSE, fig.cap = "Religious affiliation of visited private high schools"}
knitr::include_graphics('./../assets/figures/ego_network_figure_religion_pubu_privu_privc.pdf')
#knitr::include_graphics('./../assets/figures/ego_network_figure_religion_pubu_privu.pdf')
```

\newpage

```{r ego-network-figure-g12-enroll, fig.align = 'center', echo = FALSE, fig.cap = "12th grade enrollment of visited private high schools"}
knitr::include_graphics('./../assets/figures/ego_network_figure_g12_enroll_pubu_privu_privc.pdf')
#knitr::include_graphics('./../assets/figures/ego_network_figure_g12_enroll_pubu_privu.pdf')
```

\newpage

```{r ego-network-figure-hs-rank, fig.align = 'center', echo = FALSE, fig.cap = "High school rank of visited private high schools"}
knitr::include_graphics('./../assets/figures/ego_network_figure_hs_rank_pubu_privu_privc.pdf')
#knitr::include_graphics('./../assets/figures/ego_network_figure_hs_rank_pubu_privu.pdf')
```


\newpage

```{r ego-network-figure-race, fig.align = 'center', echo = FALSE, fig.cap = "Racial composition of visited private high schools"}
knitr::include_graphics('./../assets/figures/ego_network_figure_pct_black_latinx_native_pubu_privu_privc.pdf')
#knitr::include_graphics('./../assets/figures/ego_network_figure_pct_black_latinx_native_pubu_privu.pdf')
```












<!-- RQ3: Overlapping sets of high schools -->

\newpage

```{r, echo = FALSE, eval = FALSE}
g_1mode_pubu <- g_1mode_pubu_psi

vertex_attr(graph=g_1mode_pubu, name='name') <- vertex_attr(graph=g_1mode_pubu, name='school_name') 

m_1mode_pubu <- as_adjacency_matrix(
  #graph = g_1mode_u_psi,
  graph = g_1mode_pubu,
  type = "both",
  attr="weight",
  names = TRUE,
  #edges = TRUE,
  #sparse = igraph_opt("sparsematrices")
  sparse = FALSE
)

m_1mode_pubu
```


```{r, echo = FALSE, eval = FALSE}
g_1mode_privu <- g_1mode_privu_psi

vertex_attr(graph=g_1mode_privu, name='name') <- vertex_attr(graph=g_1mode_privu, name='school_name') 

m_1mode_privu <- as_adjacency_matrix(
  #graph = g_1mode_u_psi,
  graph = g_1mode_privu,
  type = "both",
  attr="weight",
  names = TRUE,
  #edges = TRUE,
  #sparse = igraph_opt("sparsematrices")
  sparse = FALSE
)

m_1mode_privu
```

\newpage

\newgeometry{top=1in, left=0cm, right=0cm, bottom=0cm}

\begin{landscape}


```{r plot-1mode-pubu, fig.align = 'center', echo = FALSE, out.width = "100%", fig.cap = "One-mode network for public institutions, colored by cluster"}
knitr::include_graphics('./../assets/figures/plot_1mode_pubu.pdf')
```

```{r plot-1mode-privu, fig.align = 'center', echo = FALSE, out.width = "100%", fig.cap = "One-mode network for private universities, colored by cluster"}
knitr::include_graphics('./../assets/figures/plot_1mode_privu.pdf')
```



```{r plot-1mode-u, fig.align = 'center', echo = FALSE, eval = FALSE, out.width = "100%", fig.cap = "One-mode network for public and private universities, colored by cluster"}
knitr::include_graphics('./../assets/figures/plot_1mode_u.pdf')
```

```{r plot-1mode-u-k5, fig.align = 'center', echo = FALSE, out.width = "100%", fig.cap = "One-mode network for public and private universities, colored by cluster, five clusters"}
knitr::include_graphics('./../assets/figures/plot_1mode_u_k5.pdf')
```

```{r plot-2mode-u-k5, fig.align = 'center', echo = FALSE, eval = FALSE, out.width = "100%", fig.cap = "Two-mode network for public and private universities, colored by cluster, five clusters"}

knitr::include_graphics('./../assets/figures/plot_2mode_u_k5.pdf')

#https://stackoverflow.com/questions/15625990/how-to-set-size-for-local-image-using-knitr-for-markdown
```


```{r plot-1mode-privc, fig.align = 'center', echo = FALSE, out.width = "100%", fig.cap = "One-mode network for private liberal arts colleges, colored by cluster"}
# appendix
knitr::include_graphics('./../assets/figures/plot_1mode_privc.pdf')
```



```{r plot-1mode-all-k5, fig.align = 'center', echo = FALSE, out.width = "100%", fig.cap = "One-mode network for public universities, private universities, private liberal arts, colored by cluster, five clusters"}
# appendix
knitr::include_graphics('./../assets/figures/plot_1mode_all_k5.pdf')
```




```{r plot-1mode-pubu-outst, fig.align = 'center', echo = FALSE, eval = FALSE, out.width = "100%", fig.cap = "One-mode network for public institutions, out-of-state visits only, colored by cluster"}
knitr::include_graphics('./../assets/figures/plot_1mode_pubu_outst.pdf')
```


```{r plot-1mode-u-pubu-outst, fig.align = 'center', echo = FALSE, eval = FALSE, out.width = "100%", fig.cap = "One-mode network for public and private universities, out-of-state visits only for public universities, colored by cluster"}
knitr::include_graphics('./../assets/figures/plot_1mode_u_pubu_outst.pdf')
```

```{r plot-1mode-all-pubu-outst, fig.align = 'center', echo = FALSE, eval = FALSE, out.width = "100%", fig.cap = "One-mode network for all institutions, out-of-state visits only for public universities, colored by cluster"}
knitr::include_graphics('./../assets/figures/plot_1mode_all_pubu_outst.pdf')
```


```{r villanova-religion, fig.align = 'center', echo = FALSE, eval=FALSE, out.width = "100%", fig.cap = "Ego network of Villanova University, colored by religious affiliation"}
#<!-- Ego networks; exclude for now -->
knitr::include_graphics('./../assets/figures/villanova_religion.pdf')
```

```{r emory-region, fig.align = 'center', echo = FALSE, eval= FALSE, out.width = "100%", fig.cap = "Ego network of Emory University, colored by geographic region"}
knitr::include_graphics('./../assets/figures/emory_region.pdf')
```

\end{landscape}









